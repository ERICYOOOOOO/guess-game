<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬¢ä¹ç«çŒœ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; }
        input, button { padding: 10px; width: 100%; box-sizing: border-box; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        button.admin-btn { background: #dc3545; }
        
        .hidden { display: none; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; transition: all 0.3s ease; }
        .leaderboard-item:first-child { font-weight: bold; color: #d9534f; } 
        
        /* è‡ªå·±çš„åå­—é«˜äº® */
        .my-row { background-color: #e3f2fd; border-left: 4px solid #007bff; }

        #my-status { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        
        /* åˆ†æ•°è·³åŠ¨åŠ¨ç”» */
        .score-change { color: red; transform: scale(1.3); transition: transform 0.2s; display: inline-block; }

        .status-bar { font-size: 12px; color: #888; text-align: right; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="login-view" class="card hidden">
        <h2>ğŸ‘‹ æ¬¢è¿ï¼è¯·å…ˆç•™ä¸ªå</h2>
        <input type="text" id="username-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
        <button onclick="login()">è¿›å…¥æ¸¸æˆ</button>
    </div>

    <div id="game-view" class="card hidden">
        <div id="my-status">
            ä½ å¥½ï¼Œ<span id="display-name"></span>ï¼å½“å‰ç§¯åˆ†: <strong id="display-score">0</strong>
        </div>

        <h3>ğŸ“ æäº¤æœ¬è½®ç«çŒœ</h3>
        <p id="round-status-text" style="color:gray; font-size: 0.9em;">æœ¬è½®ç«çŒœè¿›è¡Œä¸­...</p>
        <input type="text" id="guess-input" placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆ (ä¾‹å¦‚: A)">
        <button onclick="submitGuess()">æäº¤ç­”æ¡ˆ</button>
        <p id="guess-feedback" style="color: green; margin-top: 5px; font-weight: bold;"></p>
    </div>

    <div class="card">
        <h3>ğŸ† å®æ—¶æ’è¡Œæ¦œ</h3>
        <div class="status-bar">ä¸Šæ¬¡æ•°æ®æ›´æ–°: <span id="last-updated">--:--:--</span></div>
        <div id="leaderboard-list">æ­£åœ¨åŠ è½½...</div>
    </div>

    <div class="card" style="border-top: 3px solid red;">
        <h3>ğŸ”§ ç®¡ç†å‘˜æ§åˆ¶å°</h3>
        <input type="text" id="admin-answer" placeholder="è¾“å…¥æ­£ç¡®ç­”æ¡ˆè¿›è¡Œç»“ç®—">
        <button class="admin-btn" onclick="adminSettle()">ç»“ç®—æœ¬è½®å¹¶åŠ åˆ†</button>
    </div>

    <script>
        // å®šä¹‰å…¨å±€å˜é‡
        let lastScore = 0; 
        let isFirstLoad = true;

        // é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
        fetchStatus();

        // --- æ ¸å¿ƒï¼šæ¯ 2 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ ---
        setInterval(() => {
            fetchStatus(true); // true ä»£è¡¨è¿™æ˜¯è‡ªåŠ¨åˆ·æ–°
        }, 2000);

        async function fetchStatus(isAutoRefresh = false) {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // 1. æ›´æ–°â€œä¸Šæ¬¡æ›´æ–°æ—¶é—´â€ (å¿ƒè·³æŒ‡ç¤ºå™¨)
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                document.getElementById('last-updated').innerText = timeString;

                // 2. æ›´æ–°æ’è¡Œæ¦œ HTML
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = data.leaderboard.map((u, i) => {
                    // åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯ï¼ŒåŠ ä¸ªé«˜äº®æ ·å¼
                    const isMe = u.name === data.currentUser;
                    const rankEmoji = i === 0 ? 'ğŸ¥‡ ' : (i === 1 ? 'ğŸ¥ˆ ' : (i === 2 ? 'ğŸ¥‰ ' : `#${i+1} `));
                    return `
                    <div class="leaderboard-item ${isMe ? 'my-row' : ''}">
                        <span>${rankEmoji} ${u.name}</span> 
                        <strong>${u.score}åˆ†</strong>
                    </div>`;
                }).join('');

                // 3. å¤„ç†ç™»å½•çŠ¶æ€å’Œè§†å›¾åˆ‡æ¢
                if (data.isLoggedIn) {
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('game-view').classList.remove('hidden');
                    document.getElementById('display-name').innerText = data.currentUser;
                    
                    // 4. åˆ†æ•°å˜åŒ–ç‰¹æ•ˆ
                    const scoreElem = document.getElementById('display-score');
                    // åªæœ‰å½“ åˆ†æ•°å˜å¤§ ä¸” ä¸æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½é¡µé¢æ—¶ï¼Œæ‰æ’­æ”¾åŠ¨ç”»
                    if (data.myScore > lastScore && !isFirstLoad) {
                        console.log("åˆ†æ•°å¢åŠ äº†ï¼æ’­æ”¾åŠ¨ç”»");
                        scoreElem.classList.add('score-change');
                        setTimeout(() => scoreElem.classList.remove('score-change'), 500);
                    }
                    scoreElem.innerText = data.myScore;
                    lastScore = data.myScore; // æ›´æ–°è®°å½•
                    isFirstLoad = false;

                    // 5. ç«çŒœåé¦ˆ
                    if (data.myGuess) {
                        document.getElementById('guess-feedback').innerText = `âœ… ä½ å·²æäº¤: ${data.myGuess}`;
                    } else {
                        document.getElementById('guess-feedback').innerText = '';
                    }
                } else {
                    document.getElementById('login-view').classList.remove('hidden');
                }

            } catch (e) {
                console.error("åˆ·æ–°çŠ¶æ€å¤±è´¥:", e);
                // å¯ä»¥åœ¨è¿™é‡ŒæŠŠ 'last-updated' å˜æˆçº¢è‰²ï¼Œæç¤ºç”¨æˆ·ç½‘ç»œæ–­äº†
                document.getElementById('last-updated').style.color = 'red';
            }
        }

        async function login() {
            const username = document.getElementById('username-input').value;
            if(!username) return alert('è¯·è¾“å…¥åå­—');
            
            await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            fetchStatus(); 
        }

        async function submitGuess() {
            const guess = document.getElementById('guess-input').value;
            if(!guess) return alert('è¯·å¡«å†™ç­”æ¡ˆ');

            const res = await fetch('/api/guess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guess })
            });
            
            if(res.ok) {
                fetchStatus(); // æäº¤åç«‹å³åˆ·æ–°ä¸€æ¬¡
            } else {
                alert(await res.text());
            }
        }

        async function adminSettle() {
            const correctAnswer = document.getElementById('admin-answer').value;
            if(!correctAnswer) return alert('è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ');
            if(!confirm(`ç¡®å®šæ­£ç¡®ç­”æ¡ˆæ˜¯ "${correctAnswer}" å—ï¼Ÿ`)) return;

            const res = await fetch('/api/admin/settle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ correctAnswer })
            });

            const data = await res.json();
            alert(`ç»“ç®—å®Œæˆï¼å…±æœ‰ ${data.winners.length} äººç­”å¯¹ã€‚`);
            fetchStatus(); // ç»“ç®—åç«‹å³åˆ·æ–°
        }
    </script>
</body>
</html>